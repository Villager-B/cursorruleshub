name: Repository Maintenance

on:
  schedule:
    - cron: '0 1 * * 1'  # æ¯é€±æœˆæ›œæ—¥ã®UTC 01:00ã«å®Ÿè¡Œï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ã®30åˆ†å¾Œï¼‰
  pull_request:
    branches: [ main ]  # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®PRã®ã¿ã«å¤‰æ›´
  workflow_dispatch:    # æ‰‹å‹•å®Ÿè¡Œã¯æ®‹ã—ã¦ãŠã

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety

      - name: Run Bandit
        run: bandit -r . -ll -ii -x ./venv,./tests

      - name: Check dependencies with Safety
        run: safety check

      - name: Run CodeQL Analysis
        uses: github/codeql-action/init@v2
        with:
          languages: python, javascript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

  dependency-update:
    needs: security-scan
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'  # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œã¾ãŸã¯æ‰‹å‹•å®Ÿè¡Œæ™‚
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Update dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pip-tools
          pip-compile --upgrade requirements.txt

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: 'chore: update dependencies'
          title: 'ğŸ“¦ ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æ›´æ–°'
          body: |
            ## ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æ›´æ–°
            
            ã“ã®PRã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚
            ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ãŒå®Œäº†ã—ã€å•é¡ŒãŒãªã„ã“ã¨ã‚’ç¢ºèªæ¸ˆã¿ã§ã™ã€‚
            
            ### ç¢ºèªé …ç›®
            - [ ] CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒæ­£å¸¸ã«å®Œäº†ã™ã‚‹ã“ã¨
            - [ ] ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨
          branch: update-dependencies
          base: develop
          labels: dependencies, security-approved 